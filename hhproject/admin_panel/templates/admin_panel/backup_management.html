{% extends 'base.html' %}
{% load static %}

{% block title_name %}Управление бэкапами - Админ панель{% endblock %}

{% block style %}
<style>
/* Общие стили админки остаются без изменений */
.admin-wrapper {
    min-height: calc(100vh - 115px);
    background: var(--bg-primary);
    padding: 30px 0;
    display: flex;
    gap: 30px;
}

.admin-sidebar {
    width: 280px;
    background: var(--bg-card);
    border-right: 1px solid var(--border-color);
    border-radius: 0 20px 20px 0;
    box-shadow: var(--shadow-lg);
    position: sticky;
    top: 115px;
    height: calc(100vh - 115px);
    overflow-y: auto;
    flex-shrink: 0;
}

.admin-main {
    flex: 1;
    padding-right: 30px;
}

.admin-container {
    max-width: 1400px;
}

/* Сайдбар и остальные базовые стили остаются как есть */

/* Новые стили для системы бэкапов */
.backup-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.backup-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 25px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
}

.backup-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.backup-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.backup-card-header i {
    font-size: 1.5rem;
    color: var(--accent);
}

.backup-card-header h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.3rem;
    font-weight: 600;
}

/* Статус системы */
.system-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-item {
    background: var(--bg-primary);
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid var(--border-color);
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Формы создания бэкапа */
.backup-options {
    display: grid;
    gap: 15px;
}

.option-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.option-label {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 5px;
}

.option-description {
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.4;
}

/* Кнопки действий */
.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-top: 20px;
}

.btn-backup {
    padding: 12px 20px;
    border: none;
    border-radius: 10px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.9rem;
    text-align: center;
}

.btn-backup-primary {
    background: var(--primary);
    color: white;
}

.btn-backup-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}

.btn-backup-success {
    background: #10b981;
    color: white;
}

.btn-backup-success:hover {
    background: #059669;
    transform: translateY(-2px);
}

.btn-backup-warning {
    background: #f59e0b;
    color: white;
}

.btn-backup-warning:hover {
    background: #d97706;
    transform: translateY(-2px);
}

.btn-backup-info {
    background: #3b82f6;
    color: white;
}

.btn-backup-info:hover {
    background: #2563eb;
    transform: translateY(-2px);
}

.btn-backup-danger {
    background: #ef4444;
    color: white;
}

.btn-backup-danger:hover {
    background: #dc2626;
    transform: translateY(-2px);
}

/* Загрузка файлов */
.file-upload-area {
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background: var(--bg-primary);
}

.file-upload-area:hover {
    border-color: var(--primary);
    background: rgba(59, 130, 246, 0.05);
}

.file-upload-area.dragover {
    border-color: var(--primary);
    background: rgba(59, 130, 246, 0.1);
}

.file-upload-icon {
    font-size: 3rem;
    color: var(--text-secondary);
    margin-bottom: 15px;
}

.file-upload-text {
    color: var(--text-primary);
    margin-bottom: 10px;
}

.file-upload-hint {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.file-input {
    display: none;
}

/* Модальные окна */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    background: var(--bg-card);
    margin: 5% auto;
    padding: 0;
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-lg);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 20px 25px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.3rem;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    color: var(--text-primary);
}

.modal-body {
    padding: 25px;
}

.modal-footer {
    padding: 20px 25px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

/* Прогресс бар */
.progress-bar {
    width: 100%;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    overflow: hidden;
    margin: 15px 0;
}

.progress-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 3px;
    transition: width 0.3s ease;
    width: 0%;
}

/* Уведомления */
.notification {
    position: fixed;
    top: 100px;
    right: 30px;
    padding: 15px 20px;
    border-radius: 10px;
    color: white;
    font-weight: 500;
    z-index: 1001;
    animation: slideInRight 0.3s ease-out;
    box-shadow: var(--shadow-lg);
    max-width: 400px;
}

.notification.success {
    background: #10b981;
}

.notification.error {
    background: #ef4444;
}

.notification.warning {
    background: #f59e0b;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Адаптивность для новых элементов */
@media (max-width: 768px) {
    .backup-grid {
        grid-template-columns: 1fr;
    }
    
    .system-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .action-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        margin: 10% auto;
        width: 95%;
    }
    
    .notification {
        right: 15px;
        left: 15px;
        max-width: none;
    }
}

/* Индикатор загрузки */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Состояния процедур */
.procedure-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 500;
}

.status-ok {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.status-error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.status-warning {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.2);
}

/* Таблица бэкапов */
.table-responsive {
    overflow-x: auto;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg-card);
    border-radius: 12px;
    overflow: hidden;
}

.admin-table th,
.admin-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.admin-table th {
    background: var(--bg-primary);
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.admin-table tr:hover {
    background: var(--bg-primary);
}

.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.btn-admin-sm {
    padding: 6px 12px;
    font-size: 0.8rem;
}

.badge {
    background: var(--primary);
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Пустой список */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state h3 {
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.empty-state p {
    color: var(--text-secondary);
    opacity: 0.8;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-wrapper">
    <!-- Боковая панель -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-cogs"></i> Панель управления</h3>
        </div>
        <nav class="sidebar-nav">
            <a href="{% url 'admin_dashboard' %}" class="nav-item {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Дашборд</span>
                </div>
            </a>
            <a href="{% url 'admin_company_moderation' %}" class="nav-item {% if 'company' in request.resolver_match.url_name %}active{% endif %}">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-building"></i>
                    <span>Модерация компаний</span>
                </div>
                {% if pending_companies_count %}
                    <span class="badge">{{ pending_companies_count }}</span>
                {% endif %}
            </a>
            <a href="{% url 'admin_complaints' %}" class="nav-item {% if 'complaint' in request.resolver_match.url_name %}active{% endif %}">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-flag"></i>
                    <span>Жалобы на вакансии</span>
                </div>
                {% if pending_complaints_count %}
                    <span class="badge">{{ pending_complaints_count }}</span>
                {% endif %}
            </a>
            <a href="{% url 'admin_backup_management' %}" class="nav-item {% if 'backup' in request.resolver_match.url_name %}active{% endif %}">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-database"></i>
                    <span>Управление бэкапами</span>
                </div>
            </a>
            {% if user.is_superuser %}
            <a href="{% url 'admin_management' %}" class="nav-item {% if 'site-admins' in request.resolver_match.url_name %}active{% endif %}">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-users-cog"></i>
                    <span>Администраторы сайта</span>
                </div>
                {% if site_admins_count %}
                    <span class="badge">{{ site_admins_count }}</span>
                {% endif %}
            </a>
            {% endif %}
            <a href="{% url 'admin_logs' %}" class="nav-item {% if 'logs' in request.resolver_match.url_name %}active{% endif %}">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Логи действий</span>
                </div>
            </a>
            <a href="{% url 'admin_profile' %}" class="nav-item">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-user-shield"></i>
                    <span>Мой профиль</span>
                </div>
            </a>
            <a href="{% url 'admin_statistics' %}" class="nav-item">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-chart-bar"></i>
                    <span>Статистика сайта</span>
                </div>
            </a>
        </nav>
    </aside>

    <!-- Основной контент -->
    <main class="admin-main">
        <div class="admin-container">
            <div class="admin-content-header">
                <h1>Управление бэкапами</h1>
                <p>Система резервного копирования через Django</p>
            </div>
            
             {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} animate__animated animate__fadeIn">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Основные действия -->
            <div class="backup-grid">
                <!-- Создание бэкапа -->
                <div class="backup-card">
                    <div class="backup-card-header">
                        <i class="fas fa-plus-circle"></i>
                        <h3>Создание бэкапа</h3>
                    </div>
                    <div class="backup-options">
                        <div class="option-group">
                            <label class="option-label">Тип бэкапа</label>
                            <select id="backupType" class="admin-form-control">
                                <option value="database">База данных (.json)</option>
                                <option value="media">Медиа файлы (.zip)</option>
                                <option value="full">Полный бэкап (.zip)</option>
                            </select>
                            <div class="option-description">
                                Полный бэкап включает базу данных и медиа файлы
                            </div>
                        </div>
                        
                        <div class="option-group">
                            <label class="option-label">Имя бэкапа (опционально)</label>
                            <input type="text" id="backupName" class="admin-form-control" placeholder="backup_custom_name">
                            <div class="option-description">
                                Оставьте пустым для автоматического имени
                            </div>
                        </div>
                    </div>
                    <div class="action-grid">
                        <button onclick="createBackup()" class="btn-backup btn-backup-success" id="createBackupBtn">
                            <i class="fas fa-save"></i> Создать бэкап
                        </button>
                    </div>
                </div>

                <!-- Загрузка бэкапа -->
                <div class="backup-card">
                    <div class="backup-card-header">
                        <i class="fas fa-upload"></i>
                        <h3>Загрузка бэкапа</h3>
                    </div>
                    <div class="file-upload-area" id="uploadArea" onclick="document.getElementById('backupFile').click()">
                        <div class="file-upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="file-upload-text">Нажмите для выбора файла или перетащите сюда</div>
                        <div class="file-upload-hint">Поддерживаемые форматы: .zip, .json</div>
                        <input type="file" id="backupFile" class="file-input" accept=".zip,.json">
                    </div>
                    <div class="action-grid" style="margin-top: 15px;">
                        <button onclick="uploadBackup()" class="btn-backup btn-backup-primary" id="uploadBackupBtn" disabled>
                            <i class="fas fa-upload"></i> Загрузить бэкап
                        </button>
                    </div>
                </div>

                <!-- Статус системы -->
                <div class="backup-card">
                    <div class="backup-card-header">
                        <i class="fas fa-plug"></i>
                        <h3>Статус подключения</h3>
                    </div>
                    <div id="connectionStatus">
                        <div class="procedure-status status-ok">
                            <i class="fas fa-check-circle"></i>
                            <span>Проверка подключения к БД...</span>
                        </div>
                    </div>
                    <div class="action-grid" style="margin-top: 15px;">
                        <button onclick="testConnection()" class="btn-backup btn-backup-info">
                            <i class="fas fa-vial"></i> Проверить подключение
                        </button>
                    </div>
                </div>
            </div>

            <!-- Список бэкапов -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3><i class="fas fa-list"></i> Список бэкапов</h3>
                    <button onclick="loadBackupsList()" class="btn-admin btn-admin-primary btn-admin-sm">
                        <i class="fas fa-sync-alt"></i> Обновить
                    </button>
                </div>
                <div class="admin-card-body">
                    <div id="backupsList">
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i>
                            <p>Загрузка списка бэкапов...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Модальное окно подтверждения -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Подтверждение действия</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="modalMessage">Вы уверены, что хотите выполнить это действие?</p>
        </div>
        <div class="modal-footer">
            <button class="btn-admin btn-admin-danger" onclick="confirmAction()">Подтвердить</button>
            <button class="btn-admin btn-admin-secondary" onclick="closeModal()">Отмена</button>
        </div>
    </div>
</div>

<!-- Модальное окно прогресса -->
<div id="progressModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="progressTitle">Создание бэкапа</h3>
            <button class="modal-close" onclick="closeProgressModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressMessage">Подготовка к созданию бэкапа...</p>
        </div>
    </div>
</div>

<script>
// JavaScript код для работы с системой бэкапов
let currentAction = null;
let actionParams = null;

// Загрузка статуса системы
function loadSystemStatus() {
    fetch('{% url "admin_system_status" %}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalBackups').textContent = data.total_backups || '0';
            document.getElementById('totalSize').textContent = formatFileSize(data.total_size || 0);
            document.getElementById('databaseSize').textContent = data.database_size || 'Unknown';
            document.getElementById('freeSpace').textContent = formatFileSize(data.free_space || 0);
        })
        .catch(error => {
            console.error('Error loading system status:', error);
            showNotification('Ошибка загрузки статуса системы', 'error');
        });
}

// Загрузка списка бэкапов
function loadBackupsList() {
    const backupsListElement = document.getElementById('backupsList');
    
    fetch('{% url "admin_backups_list" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderBackupsList(data.backups);
            } else {
                backupsListElement.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Ошибка загрузки</h3>
                        <p>${data.error || 'Не удалось загрузить список бэкапов'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading backups list:', error);
            backupsListElement.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Ошибка загрузки</h3>
                    <p>Не удалось загрузить список бэкапов</p>
                </div>
            `;
        });
}

// Отрисовка списка бэкапов
function renderBackupsList(backups) {
    const backupsListElement = document.getElementById('backupsList');
    
    if (backups.length === 0) {
        backupsListElement.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>Нет созданных бэкапов</h3>
                <p>Создайте первый бэкап, чтобы он появился в списке</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Тип</th>
                        <th>Размер</th>
                        <th>Дата создания</th>
                        <th>Создан</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    backups.forEach(backup => {
        html += `
            <tr>
                <td>${backup.name}</td>
                <td>
                    <span class="badge">${backup.backup_type_display}</span>
                </td>
                <td>${backup.file_size_display}</td>
                <td>${backup.created_at}</td>
                <td>${backup.created_by}</td>
                <td>
                    <div class="action-buttons">
                        <a href="${backup.download_url}" class="btn-admin btn-admin-primary btn-admin-sm">
                            <i class="fas fa-download"></i> Скачать
                        </a>
                        <button onclick="showRestoreConfirmation(${backup.id}, '${backup.name}')" class="btn-admin btn-admin-warning btn-admin-sm">
                            <i class="fas fa-redo"></i> Восстановить
                        </button>
                        <button onclick="showDeleteConfirmation(${backup.id}, '${backup.name}')" class="btn-admin btn-admin-danger btn-admin-sm">
                            <i class="fas fa-trash"></i> Удалить
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    backupsListElement.innerHTML = html;
}

// Создание бэкапа
// Глобальные переменные для отслеживания прогресса
let progressInterval = null;
let isBackupInProgress = false;

// Создание бэкапа с отслеживанием прогресса
function createBackup() {
    if (isBackupInProgress) {
        showNotification('Бэкап уже выполняется, пожалуйста подождите...', 'warning');
        return;
    }
    
    const backupType = document.getElementById('backupType').value;
    const backupName = document.getElementById('backupName').value;
    
    const btn = document.getElementById('createBackupBtn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<span class="loading"></span> Создание...';
    btn.disabled = true;
    isBackupInProgress = true;
    
    // Показываем модальное окно прогресса
    showProgressModal('Создание бэкапа', 'Подготовка к созданию бэкапа...');
    
    // Запускаем отслеживание прогресса
    startProgressTracking();
    
    const formData = new FormData();
    formData.append('type', backupType);
    if (backupName) {
        formData.append('custom_name', backupName);
    }
    
    fetch('{% url "admin_create_backup" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        stopProgressTracking();
        closeProgressModal();
        
        if (data.success) {
            showNotification(data.message || 'Бэкап успешно создан', 'success');
            loadBackupsList();
            loadSystemStatus();
            document.getElementById('backupName').value = '';
        } else {
            showNotification(data.error || 'Ошибка создания бэкапа', 'error');
        }
    })
    .catch(error => {
        stopProgressTracking();
        closeProgressModal();
        console.error('Error creating backup:', error);
        showNotification('Ошибка сети при создании бэкапа', 'error');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        isBackupInProgress = false;
    });
}

// Отслеживание прогресса
function startProgressTracking() {
    progressInterval = setInterval(function() {
        fetch('{% url "admin_backup_progress" %}')
            .then(response => response.json())
            .then(data => {
                updateProgress(data.percent, data.message);
            })
            .catch(error => {
                console.error('Error fetching progress:', error);
            });
    }, 1000); // Обновляем каждую секунду
}

function stopProgressTracking() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}

// Обновление прогресса в модальном окне
function updateProgress(percent, message) {
    const progressFill = document.getElementById('progressFill');
    const progressMessage = document.getElementById('progressMessage');
    
    if (progressFill && percent !== null) {
        progressFill.style.width = percent + '%';
    }
    
    if (progressMessage && message) {
        progressMessage.innerHTML = message;
        
        // Добавляем timestamp для отладки
        const timestamp = new Date().toLocaleTimeString();
        progressMessage.innerHTML += ` <small>(${timestamp})</small>`;
    }
}
// Загрузка бэкапа
function uploadBackup() {
    const fileInput = document.getElementById('backupFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showNotification('Выберите файл для загрузки', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('backup_file', file);
    
    const btn = document.getElementById('uploadBackupBtn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<span class="loading"></span> Загрузка...';
    btn.disabled = true;
    
    fetch('{% url "admin_upload_backup" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message || 'Бэкап успешно загружен', 'success');
            fileInput.value = '';
            document.getElementById('uploadBackupBtn').disabled = true;
            loadBackupsList();
            loadSystemStatus();
        } else {
            showNotification(data.error || 'Ошибка загрузки бэкапа', 'error');
        }
    })
    .catch(error => {
        console.error('Error uploading backup:', error);
        showNotification('Ошибка сети при загрузке бэкапа', 'error');
    })
    .finally(() => {
        btn.innerHTML = originalText;
    });
}

// Подтверждение восстановления
function showRestoreConfirmation(backupId, backupName) {
    showModal(
        'Подтверждение восстановления',
        `ВНИМАНИЕ: Вы собираетесь восстановить базу данных из бэкапа "${backupName}".<br><br>
         <strong>Это действие:</strong><br>
         • Перезапишет все текущие данные<br>
         • Может занять несколько минут<br>
         • Не может быть отменено<br><br>
         Вы уверены, что хотите продолжить?`,
        performRestore,
        {backupId: backupId, backupName: backupName}
    );
}

// Выполнение восстановления
function performRestore(params) {
    const formData = new FormData();
    formData.append('confirmed', 'true');
    
    fetch(`/admin_panel/backups/${params.backupId}/restore/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message || 'База данных успешно восстановлена', 'success');
            loadBackupsList();
        } else {
            if (data.requires_confirmation) {
                // Показываем модальное окно с подтверждением
                showModal(
                    'Подтверждение восстановления',
                    data.message,
                    performRestore,
                    {backupId: params.backupId, backupName: params.backupName}
                );
            } else {
                showNotification(data.error || 'Ошибка восстановления', 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error restoring backup:', error);
        showNotification('Ошибка сети при восстановлении', 'error');
    });
}

// Подтверждение удаления
function showDeleteConfirmation(backupId, backupName) {
    showModal(
        'Подтверждение удаления',
        `Вы уверены, что хотите удалить бэкап "${backupName}"?`,
        performDelete,
        {backupId: backupId, backupName: backupName}
    );
}

// Выполнение удаления
function performDelete(params) {
    fetch(`/admin_panel/backups/${params.backupId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message || 'Бэкап успешно удален', 'success');
            loadBackupsList();
            loadSystemStatus();
        } else {
            showNotification(data.error || 'Ошибка удаления бэкапа', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting backup:', error);
        showNotification('Ошибка сети при удалении', 'error');
    });
}

// Показать уведомление
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Форматирование размера файла
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadSystemStatus();
    loadBackupsList();
    testConnection();
    loadMediaStats();
    
    // Обработка drag & drop для загрузки файлов
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('backupFile');
    
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function() {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            document.getElementById('uploadBackupBtn').disabled = false;
        }
    });
    
    fileInput.addEventListener('change', function() {
        document.getElementById('uploadBackupBtn').disabled = !this.files.length;
    });
});

// Тестирование подключения
function testConnection() {
    fetch('{% url "admin_system_status" %}')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('connectionStatus');
            if (!data.error) {
                statusElement.innerHTML = `
                    <div class="procedure-status status-ok">
                        <i class="fas fa-check-circle"></i>
                        <span>Подключение к БД: OK</span>
                    </div>
                `;
            } else {
                statusElement.innerHTML = `
                    <div class="procedure-status status-error">
                        <i class="fas fa-times-circle"></i>
                        <span>Ошибка подключения: ${data.error}</span>
                    </div>
                `;
            }
        })
        .catch(error => {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.innerHTML = `
                <div class="procedure-status status-error">
                    <i class="fas fa-times-circle"></i>
                    <span>Ошибка проверки подключения</span>
                </div>
            `;
        });
}

// Модальные окна
function showModal(title, message, action, params = null) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').innerHTML = message;
    currentAction = action;
    actionParams = params;
    document.getElementById('confirmModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('confirmModal').style.display = 'none';
    currentAction = null;
    actionParams = null;
}

function confirmAction() {
    if (currentAction) {
        currentAction(actionParams);
    }
    closeModal();
}

function showProgressModal(title, message) {
    document.getElementById('progressTitle').textContent = title;
    document.getElementById('progressMessage').textContent = message;
    document.getElementById('progressModal').style.display = 'block';
}

function closeProgressModal() {
    document.getElementById('progressModal').style.display = 'none';
}

function updateProgress(percent, message) {
    document.getElementById('progressFill').style.width = percent + '%';
    document.getElementById('progressMessage').textContent = message;
}

function loadMediaStats() {
    const mediaStatsElement = document.getElementById('mediaStats');
    
    fetch('{% url "admin_media_stats" %}')
        .then(response => response.json())
        .then(data => {
            let html = '';
            
            if (data.exists) {
                html = `
                    <div class="system-stats">
                        <div class="stat-item">
                            <div class="stat-value">${data.total_files}</div>
                            <div class="stat-label">Всего файлов</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${data.total_size_formatted}</div>
                            <div class="stat-label">Общий размер</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <h4>Типы файлов:</h4>
                        <div style="font-size: 0.9rem; max-height: 100px; overflow-y: auto;">
                `;
                
                // Показываем топ-10 типов файлов
                const fileTypes = Object.entries(data.file_types)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                fileTypes.forEach(([ext, count]) => {
                    html += `<div>${ext || 'без расширения'}: ${count} файлов</div>`;
                });
                
                html += `
                        </div>
                        <h4 style="margin-top: 15px;">Крупнейшие файлы:</h4>
                        <div style="font-size: 0.8rem; max-height: 120px; overflow-y: auto;">
                `;
                
                data.largest_files_formatted.forEach(([path, size]) => {
                    const fileName = path.split('/').pop() || path;
                    html += `<div title="${path}">${fileName}: ${size}</div>`;
                });
                
                html += `</div>`;
            } else {
                html = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Медиа директория не найдена</p>
                    </div>
                `;
            }
            
            mediaStatsElement.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading media stats:', error);
            mediaStatsElement.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--error);">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Ошибка загрузки статистики</p>
                </div>
            `;
        });
}
</script>
{% endblock %}